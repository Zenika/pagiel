version: "3.3"

services:

  mongo:
    image: mongo
    container_name: mongo
    restart: always
    volumes:
      - ./mongo/data:/data/db
      - ./mongo/config:/data/configdb
    ports:
      - "27017:27017"
      - "27018:27018"
    networks:
      - ecoplatform

  mongo-express:
    image: mongo-express
    container_name: mongo-express
    depends_on: 
      - mongo   
    restart: always
    ports:
      - 8081:8081
    networks:
      - ecoplatform
      
  powerapi-hwpc-sensor:
    image: 'powerapi/hwpc-sensor:latest'
    container_name: hwpc-sensor
    privileged: true
    depends_on:
      - mongo
    links:
      - mongo
    volumes:
      - '/sys:/sys'
      - '/var/lib/docker/containers:/var/lib/docker/containers:ro'
      - '/tmp/powerapi-sensor-reporting-firefox:/reporting'
    command: /usr/bin/hwpc-sensor -n "hwpc-sensor" -r "mongodb" -U $MONGO_URI -D $DB -C $INPUT_COLLECTION -s "rapl" -o -e "RAPL_ENERGY_PKG" -s "msr" -e "TSC" -e "APERF" -e "MPERF" -c "core" -e "CPU_CLK_THREAD_UNHALTED:REF_P" -e "CPU_CLK_THREAD_UNHALTED:THREAD_P" -e "LLC_MISSES" -e "INSTRUCTIONS_RETIRED"
    networks:
      - ecoplatform
    
  formula:
    image: powerapi/smartwatts-formula
    container_name: formula
    depends_on:
      - mongo
    command: -s --input mongodb --model HWPCReport -u $MONGO_URI -d $DB -c $INPUT_COLLECTION --output mongodb --name power --model PowerReport -u $MONGO_URI -d $DB -c $OUTPUT_COLLECTION --output mongodb --name formula --model FormulaReport -u $MONGO_URI -d $DB -c frep --output influxdb --name influx --uri $INFLUXDB_HOST --port $INFLUXDB_PORT --db $INFLUXDB_DB_NAME --formula smartwatts --cpu-ratio-base $BASE_CPU_RATIO --cpu-ratio-min $MIN_CPU_RATIO --cpu-ratio-max $MAX_CPU_RATIO --cpu-error-threshold 2.0 --dram-error-threshold 2.0 --disable-dram-formula
    networks:
      - ecoplatform
  
  front-vue:
    build: ./front-vuejs
    container_name: front-vue
    ports:
      - 8090:8080
    depends_on:
      - api-node
    environment:
      - VUE_APP_API_URL="http://api-node:3031"
    networks:
      - ecoplatform

  api-node:
    build: ./api-nodejs
    container_name: api-node
    ports: 
      - 3040:3031
    networks:
      - ecoplatform

  selenium-hub:
    image: selenium/hub:4.0.0-beta-1-prerelease-20210207
    container_name: selenium-hub
    expose:
      - 4444    
    ports:
      - "4442:4442"
      - "4443:4443"
      - "4444:4444"
    networks:
      - ecoplatform

  chrome:
    image: selenium/node-chrome:4.0.0-beta-1-prerelease-20210207
    container_name: selenium-node-chrome
    volumes:
      - /dev/shm:/dev/shm
    depends_on:
      - selenium-hub
    environment:
      - SE_EVENT_BUS_HOST=selenium-hub
      - SE_EVENT_BUS_PUBLISH_PORT=4442
      - SE_EVENT_BUS_SUBSCRIBE_PORT=4443
    ports:
      - "6900:5900"
    networks:
      - ecoplatform

  robot-chrome-test:
    build: robot
    command: -v BROWSER:gc --outputdir /out /tests
   # restart: always
    container_name: robot-chrome-test
    volumes:
      - ./robot/tests:/tests:ro
      - ./results/gc:/out:rw
    depends_on:
      - selenium-hub
      - front-vue
      - chrome
      # network_mode: host
    networks:
      - ecoplatform

  influxdb:
    image: influxdb:latest
    container_name: influxdb
    ports:
      - '8086:8086'
    volumes:
      - influxdb-storage:/var/lib/influxdb
    environment:
      - INFLUXDB_DB=db0
      - INFLUXDB_ADMIN_USER=${INFLUXDB_USERNAME}
      - INFLUXDB_ADMIN_PASSWORD=${INFLUXDB_PASSWORD}
    networks:
      - ecoplatform
 
  grafana:
    container_name: grafana
    image: grafana/grafana:latest
    ports:
      - '3000:3000'
    volumes:
      - grafana-storage:/var/lib/grafana
      - ./grafana-provisioning/:/etc/grafana/provisioning
    depends_on:
      - influxdb
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_USERNAME}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD}
    networks:
      - ecoplatform

volumes:
  influxdb-storage:
  chronograf-storage:
  grafana-storage:

networks:
  ecoplatform: